{% extends 'web/base.html' %}
{% block title %}Register - Taskflow{% endblock %}

{% block layout %}
<!-- Auth layout: no sidebar -->
<div class="auth-layout">
  <div class="auth-form-card">
    <div class="card card-accent">
      <div class="text-center mb-4">
        <div class="avatar-circle avatar-xl" style="margin: 0 auto 1rem; background: linear-gradient(135deg, var(--color-success) 0%, #059669 100%);">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <line x1="19" y1="8" x2="19" y2="14"></line>
            <line x1="22" y1="11" x2="16" y2="11"></line>
          </svg>
        </div>
        <h2 style="margin-bottom: 0.375rem;">Start your journey</h2>
        <p class="text-muted" style="margin-bottom: 0;">Create an account to manage your workflow</p>
      </div>

      <div id="error-alert" class="alert alert-error" style="display: none; margin-bottom: 1rem;"></div>

      <form id="register-form">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" required placeholder="name@company.com" />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required placeholder="Create a strong password" />
        </div>
        <div class="form-group">
          <label for="role">I want to be a:</label>
          <select id="role">
            <option value="MEMBER">Team Member</option>
            <option value="ADMIN">Organization Admin</option>
          </select>
          <p class="form-hint mt-2">This determines your permissions in organizations you create.</p>
        </div>
        <button type="submit" id="submit-btn" class="btn btn-primary btn-block">
          <span class="btn-text">Create Account â†’</span>
          <span class="spinner"></span>
        </button>
      </form>

      <div class="text-center mt-6 border-t" style="padding-top: 1.25rem;">
        <p class="text-small text-muted" style="margin-bottom: 0;">
          Already have an account?
          <a href="/login/" class="text-primary font-semibold">Sign in</a>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container" class="toast-container"></div>
{% load static %}
<script src="{% static 'web/js/app.js' %}"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("register-form");
    form.addEventListener("submit", handleRegister);
  });

  async function handleRegister(e) {
    e.preventDefault();

    const btn = document.getElementById("submit-btn");
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const role = document.getElementById("role").value;

    btn.classList.add("loading");
    btn.disabled = true;
    document.getElementById("error-alert").style.display = "none";

    try {
      const response = await fetch("/api/accounts/register/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password, role }),
      });

      if (response.ok) {
        showToast("Account created successfully! Redirecting to login...", "success");
        setTimeout(() => { window.location.href = "/login/"; }, 1500);
      } else {
        let errorMsg = "Registration failed";
        try {
          const data = await response.json();
          if (data.email) errorMsg = `Email: ${data.email.join(", ")}`;
          else if (data.password) errorMsg = `Password: ${data.password.join(", ")}`;
          else if (data.detail) errorMsg = data.detail;
          else errorMsg = JSON.stringify(data);
        } catch (e) {
          errorMsg = "Server Error: Please try again later.";
        }

        showRegError(errorMsg);
      }
    } catch (error) {
      showRegError("Network error. Please check your connection.");
    } finally {
      btn.classList.remove("loading");
      btn.disabled = false;
    }
  }

  function showRegError(htmlContent) {
    const el = document.getElementById("error-alert");
    el.innerHTML = htmlContent;
    el.style.display = "flex";
  }
</script>
{% endblock %}
