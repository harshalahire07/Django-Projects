{% extends 'web/base.html' %}
{% block title %}Register - Taskflow{% endblock %}
{% block content %}
<div class="auth-form-card">
  <div class="card card-hover" style="border-top: 4px solid var(--color-primary);">
    <div style="text-align: center; margin-bottom: 2rem">
      <div class="avatar-circle" style="width: 48px; height: 48px; margin: 0 auto 1rem auto; font-size: 1.5rem; background: linear-gradient(135deg, var(--color-success) 0%, #059669 100%); box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);">
        ðŸš€
      </div>
      <h2 style="font-size: 1.75rem; margin-bottom: 0.5rem">Start your journey</h2>
      <p class="text-muted">Create an account to manage your workflow</p>
    </div>

    <div id="error-alert" class="alert alert-error" style="display: none"></div>

    <form id="register-form">
      <div class="form-group">
        <label for="email">Email Address</label>
        <input
          type="email"
          id="email"
          required
          placeholder="name@company.com"
        />
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input
          type="password"
          id="password"
          required
          placeholder="Create a strong password"
        />
      </div>
      <div class="form-group">
        <label for="role">I want to be a:</label>
        <select id="role">
          <option value="MEMBER">Team Member</option>
          <option value="ADMIN">Organization Admin</option>
        </select>
        <p class="text-xs text-muted mt-2">(Note: This determines your permissions in organizations you create)</p>
      </div>
      <button type="submit" id="submit-btn" class="btn btn-primary btn-block">
        Create Account &rarr;
      </button>
    </form>

    <div style="text-align: center; margin-top: 2rem; border-top: 1px solid var(--color-border); padding-top: 1.5rem;">
      <p class="text-small text-muted">
        Already have an account?
        <a href="/login/" style="color: var(--color-primary); font-weight: 600"
          >Sign in</a
        >
      </p>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("register-form");
    form.addEventListener("submit", handleRegister);
  });

  async function handleRegister(e) {
    e.preventDefault();

    const btn = document.getElementById("submit-btn");
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const role = document.getElementById("role").value;

    btn.disabled = true;
    btn.textContent = "Creating Account...";
    document.getElementById("error-alert").style.display = "none";

    try {
      const response = await fetch("/api/accounts/register/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password, role }),
      });

      if (response.ok) {
        // Success animation or message could go here
        window.location.href = "/login/";
      } else {
        let errorMsg = "Registration failed";
        try {
          const data = await response.json();
          if (data.email) errorMsg = `Email: ${data.email.join(", ")}`;
          else if (data.password) errorMsg = `Password: ${data.password.join(", ")}`;
          else if (data.detail) errorMsg = data.detail;
          else errorMsg = JSON.stringify(data);
        } catch (e) {
          const text = await response.text();
          console.error("Server Error:", text);
          errorMsg = `Server Error: Please try again later.`;
        }

        showError(errorMsg);
      }
    } catch (error) {
      console.error(error);
      showError("Network error. Please check your connection.");
    } finally {
      btn.disabled = false;
      btn.textContent = "Create Account â†’";
    }
  }

  function showError(htmlContent) {
    const el = document.getElementById("error-alert");
    el.innerHTML = htmlContent;
    el.style.display = "block";
  }
</script>
{% endblock %}
