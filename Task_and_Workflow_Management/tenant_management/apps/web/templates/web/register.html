{% extends 'web/base.html' %} {% block content %}
<div class="auth-container">
  <h2 class="auth-title">Register</h2>

  <div id="error-alert" class="alert alert-error"></div>

  <form id="register-form">
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="email" required />
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="password" required />
    </div>
    <div class="form-group">
      <label>Role (Default: MEMBER)</label>
      <select id="role">
        <option value="MEMBER">Member</option>
        <option value="ADMIN">Admin</option>
      </select>
      <small style="color: #666; font-size: 0.8rem"
        >(Demo Role Selection)</small
      >
    </div>
    <button type="submit" id="submit-btn" class="btn btn-block">Sign Up</button>
  </form>

  <div style="text-align: center; margin-top: 1rem">
    <a href="/login/" style="color: var(--primary-color); text-decoration: none"
      >Already have an account? Login</a
    >
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("register-form");
    form.addEventListener("submit", handleRegister);
  });

  async function handleRegister(e) {
    e.preventDefault();

    const btn = document.getElementById("submit-btn");
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const role = document.getElementById("role").value;

    btn.disabled = true;
    btn.textContent = "Registering...";
    document.getElementById("error-alert").style.display = "none";

    try {
      const response = await fetch("/api/accounts/register/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password, role }),
      });

      if (response.ok) {
        alert("Registration successful! Redirecting to login...");
        window.location.href = "/login/";
      } else {
        let errorMsg = "Registration failed";
        try {
          const data = await response.json();
          if (data.email) errorMsg = `Email: ${data.email.join(", ")}`;
          else if (data.password)
            errorMsg = `Password: ${data.password.join(", ")}`;
          else if (data.detail) errorMsg = data.detail;
          else errorMsg = JSON.stringify(data);
        } catch (e) {
          // Fallback for non-JSON errors (like 500 HTML pages)
          const text = await response.text();
          console.error("Server Error:", text);
          errorMsg = `Server Error (${response.status}): Check console for details.`;
        }

        showError(errorMsg);
      }
    } catch (error) {
      console.error(error);
      showError("Network error. Please try again.");
    } finally {
      btn.disabled = false;
      btn.textContent = "Sign Up";
    }
  }

  function showError(htmlContent) {
    const el = document.getElementById("error-alert");
    el.innerHTML = htmlContent;
    el.style.display = "block";
  }
</script>
{% endblock %}
