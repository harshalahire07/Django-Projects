{% extends 'web/base.html' %}
{% block title %}Dashboard - Taskflow{% endblock %}
{% block nav_dashboard %}active{% endblock %}

{% block breadcrumb %}
<span class="current">Dashboard</span>
{% endblock %}

{% block topbar_actions %}
<button class="btn btn-primary btn-sm" onclick="openModal('create-modal')">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  New Organization
</button>
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="page-title-group">
    <h1>My Organizations</h1>
    <p>Select an organization to manage projects and teams</p>
  </div>
</div>

<div id="org-grid" class="grid grid-cols-auto">
  <!-- Skeleton loading -->
  <div class="card skeleton skeleton-card"></div>
  <div class="card skeleton skeleton-card"></div>
  <div class="card skeleton skeleton-card"></div>
</div>

<!-- Create Org Modal -->
<div id="create-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Create Organization</div>
      <button class="modal-close" onclick="closeModal('create-modal')">&times;</button>
    </div>

    <div class="form-group">
      <label for="new-org-name">Organization Name</label>
      <input type="text" id="new-org-name" placeholder="e.g. Acme Corp" />
      <p class="form-hint mt-1">This will be your workspace name.</p>
    </div>

    <div class="modal-actions">
      <button onclick="closeModal('create-modal')" class="btn btn-secondary">Cancel</button>
      <button onclick="createOrg()" class="btn btn-primary">Create Organization</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    checkAuth();
    loadOrgs();
  });

  async function loadOrgs() {
    const grid = document.getElementById("org-grid");
    try {
      const response = await fetch("/api/organizations/mine/", {
        headers: { Authorization: `Bearer ${localStorage.getItem("access_token")}` },
      });

      if (response.status === 401) { logout(); return; }
      const orgs = await response.json();

      if (orgs.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <div class="empty-icon">üè¢</div>
            <h3>No Organizations Yet</h3>
            <p>Create your first organization to start managing projects and tasks.</p>
            <button class="btn btn-primary mt-4" onclick="openModal('create-modal')">Create Organization</button>
          </div>
        `;
        return;
      }

      grid.innerHTML = orgs.map((org) => `
        <a href="/organizations/${org.id}/projects/" class="card card-hover flex flex-col justify-between" style="min-height: 170px;">
          <div class="card-body">
            <div class="flex justify-between items-start mb-3">
              <div class="avatar-circle avatar-lg" style="font-size: 0.875rem;">
                ${org.name.substring(0, 2).toUpperCase()}
              </div>
              <span class="badge badge-primary"><span class="badge-dot"></span>Owner</span>
            </div>
            <div class="card-title" style="font-size: 1.125rem;">${org.name}</div>
            <p class="text-small text-muted" style="margin-bottom: 0;">Manage projects, members, and settings.</p>
          </div>
          <div class="card-footer flex items-center">
            <span class="text-small font-medium text-primary">Enter Workspace ‚Üí</span>
          </div>
        </a>
      `).join("");
    } catch (error) {
      grid.innerHTML = '<div class="alert alert-error">Failed to load organizations. Please refresh.</div>';
    }
  }

  async function createOrg() {
    const name = document.getElementById("new-org-name").value;
    if (!name) return showToast("Organization name is required", "warning");

    try {
      const response = await fetch("/api/organizations/create/", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${localStorage.getItem("access_token")}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ name }),
      });

      if (response.ok) {
        closeModal("create-modal");
        showToast("Organization created successfully!", "success");
        loadOrgs();
      } else {
        const data = await response.json();
        showToast(data.name || "Failed to create organization", "error");
      }
    } catch (e) {
      showToast("Error creating organization", "error");
    }
  }
</script>
{% endblock %}
