{% extends 'web/base.html' %} {% block content %}
<div class="header-row">
  <div>
    <a id="back-link" href="#" class="btn btn-secondary btn-small"
      >&larr; Back to Projects</a
    >
    <h1 class="page-title" style="margin-top: 1rem">Tasks</h1>
  </div>
  <div id="admin-actions" style="display: none">
    <button class="btn" onclick="openCreateTaskModal()">+ New Task</button>
  </div>
</div>

<div id="error-container"></div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Title</th>
        <th>Assigned To</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tasks-body">
      <tr>
        <td colspan="4">Loading tasks...</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Create Task Modal -->
<div id="create-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
    <div style="background:white; margin: 5% auto; padding:2rem; width:400px; border-radius:8px;">
        <h3>Create Task</h3>
        <input type="text" id="new-task-title" placeholder="Task Title" style="margin: 1rem 0;">
        <textarea id="new-task-desc" placeholder="Description" rows="3" style="width:100%; margin-bottom:1rem; padding:0.5rem;"></textarea>
        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button onclick="closeCreateTaskModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="createTask()" class="btn">Create</button>
        </div>
    </div>
</div>

<!-- Assign Modal -->
<div
  id="assign-modal"
  style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
  "
>
  <div
    style="
      background: white;
      margin: 10% auto;
      padding: 2rem;
      width: 400px;
      border-radius: 8px;
    "
  >
    <h3>Assign Task</h3>
    <select id="assign-select" style="margin: 1rem 0"></select>
    <div style="display: flex; gap: 10px; justify-content: flex-end">
      <button onclick="closeAssignModal()" class="btn btn-secondary">
        Cancel
      </button>
      <button onclick="confirmAssign()" class="btn">Assign</button>
    </div>
  </div>
</div>
</div>

<!-- Activity Modal -->
<div id="activity-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);">
    <div style="background:white; margin: 5% auto; padding:2rem; width:500px; max-height:80vh; overflow-y:auto; border-radius:8px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h3>Task History</h3>
            <button onclick="closeActivityModal()" class="btn btn-secondary btn-small">X</button>
        </div>
        <ul id="activity-list" style="list-style:none; padding:0;"></ul>
    </div>
</div>

<script>
  let currentOrgId,
    currentProjectId,
    currentUserRole,
    currentUserId,
    usersList = [];
  let taskToAssign = null;

  document.addEventListener("DOMContentLoaded", async () => {
    const pathParts = window.location.pathname.split("/");
    currentOrgId = pathParts[2];
    currentProjectId = pathParts[4];

    document.getElementById("back-link").href =
      `/organizations/${currentOrgId}/projects/`;

    // 1. Get User ID from Token
    const token = localStorage.getItem("access_token");
    if (!token) {
      logout();
      return;
    }
    const payload = JSON.parse(atob(token.split(".")[1]));
    currentUserId = payload.user_id;

    // 2. Fetch Members to determine Role & Build Logic
    await loadMembers();

    // 3. Fetch Tasks
    await loadTasks();
  });

  async function loadMembers() {
    try {
      const response = await fetch(
        `/api/organizations/${currentOrgId}/members/`,
        {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("access_token")}`,
          },
        },
      );
      const members = await response.json();
      usersList = members;

      const me = members.find((m) => m.id == currentUserId);
      if (me) {
        currentUserRole = me.role;
        if (currentUserRole === "ADMIN") {
          document.getElementById("admin-actions").style.display = "block";
        }
      }
    } catch (e) {
      console.error("Error loading members", e);
    }
  }

  async function loadTasks() {
    const tbody = document.getElementById("tasks-body");
    try {
      const response = await fetch(
        `/api/tasks/${currentOrgId}/${currentProjectId}/list/`,
        {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("access_token")}`,
          },
        },
      );

      if (!response.ok) throw await response.json();

      const tasks = await response.json();

      if (tasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4">No tasks found.</td></tr>';
        return;
      }

      tbody.innerHTML = tasks
        .map((task) => {
          const assigneeName = task.assigned_to
            ? usersList.find((u) => u.id == task.assigned_to)?.email ||
              "Unknown"
            : "Unassigned";

          let actions = "";

          // Status Actions
          const nextStatus = getNextStatus(task.status);
          const canUpdateStatus =
            (currentUserRole === "ADMIN" ||
              task.assigned_to == currentUserId) &&
            nextStatus;

          if (canUpdateStatus) {
            actions += `<button onclick="updateStatus('${task.id}', '${nextStatus}')" class="btn btn-small btn-secondary">Mark ${formatStatus(nextStatus)}</button> `;
          }

          // Assign Actions (Admin only)
          if (currentUserRole === "ADMIN") {
            actions += `<button onclick="openAssignModal('${task.id}')" class="btn btn-small">Assign</button> `;
          }

          actions += `<button onclick="openActivityModal('${task.id}')" class="btn btn-small btn-secondary">History</button>`;

          return `
                <tr>
                    <td>
                        <div style="font-weight:500;">${task.title}</div>
                        <div style="font-size:0.85rem; color:#6b7280;">${task.description}</div>
                    </td>
                    <td>${assigneeName}</td>
                    <td><span class="status-badge status-${task.status.toLowerCase()}">${formatStatus(task.status)}</span></td>
                    <td>${actions}</td>
                </tr>
                `;
        })
        .join("");
    } catch (error) {
      tbody.innerHTML = `<tr><td colspan="4" class="alert-error">Error: ${error.detail || "Failed to load"}</td></tr>`;
    }
  }

  function getNextStatus(current) {
    if (current === "TODO") return "IN_PROGRESS";
    if (current === "IN_PROGRESS") return "DONE";
    return null;
  }

  function formatStatus(status) {
    return status.replace("_", " "); // TODO, IN PROGRESS
  }

  async function updateStatus(taskId, newStatus) {
    if (!confirm(`Change status to ${formatStatus(newStatus)}?`)) return;

    try {
      const response = await fetch(`/api/tasks/${taskId}/update-status/`, {
        method: "PATCH",
        headers: {
          Authorization: `Bearer ${localStorage.getItem("access_token")}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ status: newStatus }),
      });

      if (response.ok) {
        loadTasks(); // Reload
      } else {
        alert("Failed to update status");
      }
    } catch (e) {
      alert("Error updating status");
    }
  }

  function openAssignModal(taskId) {
    taskToAssign = taskId;
    const select = document.getElementById("assign-select");
    select.innerHTML = usersList
      .map((u) => `<option value="${u.id}">${u.email} (${u.role})</option>`)
      .join("");
    document.getElementById("assign-modal").style.display = "block";
  }

  function closeAssignModal() {
    document.getElementById("assign-modal").style.display = "none";
    taskToAssign = null;
  }

  async function confirmAssign() {
    const userId = document.getElementById("assign-select").value;
    if (!userId || !taskToAssign) return;

    try {
      const response = await fetch(
        `/api/tasks/${currentOrgId}/${taskToAssign}/assign/`,
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("access_token")}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ assigned_to: userId }),
        },
      );

      if (response.ok) {
        closeAssignModal();
        loadTasks();
      } else {
        const data = await response.json();
        alert(data.detail || "Assignment failed");
      }
    } catch (e) {
      alert("Error assigning task");
    }
  }

  // Activity Modal Logic
  async function openActivityModal(taskId) {
      document.getElementById('activity-modal').style.display = 'block';
      const list = document.getElementById('activity-list');
      list.innerHTML = '<li>Loading...</li>';
      
      try {
          const response = await fetch(`/api/tasks/${taskId}/activity/`, {
              headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
          });
          const activities = await response.json();
          
          if(activities.length === 0) {
              list.innerHTML = '<li>No activity recorded.</li>';
              return;
          }
          
          list.innerHTML = activities.map(a => `
              <li style="margin-bottom:0.5rem; padding-bottom:0.5rem; border-bottom:1px solid #eee;">
                  <div style="font-size:0.85rem; color:#6b7280;">${new Date(a.created_at).toLocaleString()}</div>
                  <div style="font-weight:500;">${a.activity_type}</div>
                  <div>${a.message}</div>
                  <div style="font-size:0.85rem; color:#9ca3af;">By: ${a.actor_email || 'Unknown'}</div>
              </li>
          `).join('');
          
      } catch(e) { list.innerHTML = '<li class="alert-error">Failed to load activity.</li>'; }
  }

  function closeActivityModal() {
      document.getElementById('activity-modal').style.display = 'none';
  }

  // Create Task Logic
  function openCreateTaskModal() {
      document.getElementById('create-modal').style.display = 'block';
  }

  function closeCreateTaskModal() {
      document.getElementById('create-modal').style.display = 'none';
      document.getElementById('new-task-title').value = '';
      document.getElementById('new-task-desc').value = '';
  }

  async function createTask() {
      const title = document.getElementById('new-task-title').value;
      const description = document.getElementById('new-task-desc').value;
      
      if (!title) return alert('Title is required');

      try {
          const response = await fetch(`/api/tasks/${currentOrgId}/${currentProjectId}/create/`, {
              method: 'POST',
              headers: {
                  'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({ title, description })
          });

          if (response.ok) {
              closeCreateTaskModal();
              loadTasks();
          } else {
              const data = await response.json();
              alert(data.detail || 'Failed to create task');
          }
      } catch (e) { alert('Error creating task'); }
  }
</script>
{% endblock %}
