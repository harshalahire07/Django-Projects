{% extends 'web/base.html' %}
{% block title %}Tasks - Taskflow{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title-group">
    <div
      style="
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
      "
    >
      <a id="back-link" href="#" class="btn btn-sm btn-secondary"
        >&larr; Projects</a
      >
      <h1 style="margin: 0">Tasks</h1>
    </div>
    <p class="text-muted" style="margin-left: 0.5rem">
      Track and manage tasks for this project
    </p>
  </div>
  <div id="admin-actions" style="display: none">
    <button class="btn btn-primary" onclick="openCreateTaskModal()">
      <span>+</span> New Task
    </button>
  </div>
</div>

<div id="error-container"></div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th style="width: 40%">Title</th>
        <th style="width: 20%">Assigned To</th>
        <th style="width: 15%">Status</th>
        <th style="width: 25%">Actions</th>
      </tr>
    </thead>
    <tbody id="tasks-body">
      <tr>
        <td colspan="4" class="text-center text-muted">Loading tasks...</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Create Task Modal -->
<div id="create-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Create Task</div>
    </div>
    <div class="form-group">
      <label for="new-task-title">Task Title</label>
      <input type="text" id="new-task-title" placeholder="Enter task title" />
    </div>
    <div class="form-group">
      <label for="new-task-desc">Description</label>
      <textarea
        id="new-task-desc"
        placeholder="Task description"
        rows="3"
      ></textarea>
    </div>
    <div class="modal-actions">
      <button onclick="closeCreateTaskModal()" class="btn btn-secondary">
        Cancel
      </button>
      <button onclick="createTask()" class="btn btn-primary">
        Create Task
      </button>
    </div>
  </div>
</div>

<!-- Assign Modal -->
<div id="assign-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Assign Task</div>
    </div>

    <div class="form-group">
      <label for="assign-select">Select Member</label>
      <select id="assign-select"></select>
    </div>

    <div class="modal-actions">
      <button onclick="closeAssignModal()" class="btn btn-secondary">
        Cancel
      </button>
      <button onclick="confirmAssign()" class="btn btn-primary">Assign</button>
    </div>
  </div>
</div>

<!-- Activity Modal -->
<div id="activity-modal" class="modal-overlay">
  <div class="modal-content" style="max-width: 600px">
    <div class="modal-header">
      <div class="modal-title">Task History</div>
      <button onclick="closeActivityModal()" class="btn btn-sm btn-secondary">
        Close
      </button>
    </div>
    <div style="max-height: 60vh; overflow-y: auto; padding-right: 0.5rem">
      <ul id="activity-list" style="list-style: none; padding: 0"></ul>
    </div>
  </div>
</div>

<script>
  let currentOrgId,
    currentProjectId,
    currentUserRole,
    currentUserId,
    usersList = [];
  let taskToAssign = null;

  document.addEventListener("DOMContentLoaded", async () => {
    const pathParts = window.location.pathname.split("/");
    currentOrgId = pathParts[2];
    currentProjectId = pathParts[4];

    document.getElementById("back-link").href =
      `/organizations/${currentOrgId}/projects/`;

    // 1. Get User ID from Token
    const token = localStorage.getItem("access_token");
    if (!token) {
      logout();
      return;
    }
    const payload = JSON.parse(atob(token.split(".")[1]));
    currentUserId = payload.user_id;

    // 2. Fetch Members to determine Role & Build Logic
    await loadMembers();

    // 3. Fetch Tasks
    await loadTasks();
  });

  async function loadMembers() {
    try {
      const response = await fetch(
        `/api/organizations/${currentOrgId}/members/`,
        {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("access_token")}`,
          },
        },
      );
      const members = await response.json();
      usersList = members;

      const me = members.find((m) => m.id == currentUserId);
      if (me) {
        currentUserRole = me.role;
        if (currentUserRole === "ADMIN") {
          document.getElementById("admin-actions").style.display = "block";
        }
      }
    } catch (e) {
      console.error("Error loading members", e);
    }
  }

  async function loadTasks() {
    const tbody = document.getElementById("tasks-body");
    try {
      const response = await fetch(
        `/api/tasks/${currentOrgId}/${currentProjectId}/list/`,
        {
          headers: {
            Authorization: `Bearer ${localStorage.getItem("access_token")}`,
          },
        },
      );

      if (!response.ok) throw await response.json();

      const tasks = await response.json();

      if (tasks.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="4" class="text-center text-muted" style="padding: 2rem;">No tasks found. Create one to get started.</td></tr>';
        return;
      }

      tbody.innerHTML = tasks
        .map((task) => {
          const assigneeName = task.assigned_to
            ? usersList.find((u) => u.id == task.assigned_to)?.email ||
              "Unknown"
            : '<span class="text-muted">Unassigned</span>';

          let actions = "";

          // Status Actions
          const nextStatus = getNextStatus(task.status);
          const canUpdateStatus =
            (currentUserRole === "ADMIN" ||
              task.assigned_to == currentUserId) &&
            nextStatus;

          // Action Container
          actions += '<div class="flex gap-2">';

          if (canUpdateStatus) {
            actions += `<button onclick="updateStatus('${task.id}', '${nextStatus}')" class="btn btn-sm btn-secondary" title="Move to ${formatStatus(nextStatus)}">Mark ${formatStatus(nextStatus)}</button>`;
          }

          // Assign Actions (Admin only)
          if (currentUserRole === "ADMIN") {
            actions += `<button onclick="openAssignModal('${task.id}')" class="btn btn-sm btn-secondary">Assign</button>`;
          }

          actions += `<button onclick="openActivityModal('${task.id}')" class="btn btn-sm btn-secondary">History</button>`;
          actions += "</div>";

          return `
                <tr>
                    <td>
                        <div class="font-medium">${task.title}</div>
                        <div class="text-small text-muted" style="margin-top: 0.25rem;">${task.description || ""}</div>
                    </td>
                    <td>
                        <div class="flex items-center gap-2">
                            ${task.assigned_to ? `<div class="avatar-circle">${assigneeName[0].toUpperCase()}</div>` : ""}
                            <span class="text-small">${assigneeName}</span>
                        </div>
                    </td>
                    <td><span class="badge ${getStatusBadgeClass(task.status)}">${formatStatus(task.status)}</span></td>
                    <td>${actions}</td>
                </tr>
                `;
        })
        .join("");
    } catch (error) {
      tbody.innerHTML = `<tr><td colspan="4" class="alert-error">Error: ${error.detail || "Failed to load"}</td></tr>`;
    }
  }

  function getStatusBadgeClass(status) {
    switch (status) {
      case "TODO":
        return "badge-todo";
      case "IN_PROGRESS":
        return "badge-warning";
      case "DONE":
        return "badge-success";
      default:
        return "badge-neutral";
    }
  }

  function getNextStatus(current) {
    if (current === "TODO") return "IN_PROGRESS";
    if (current === "IN_PROGRESS") return "DONE";
    return null;
  }

  function formatStatus(status) {
    if (!status) return "";
    return status.replace("_", " "); // TODO, IN PROGRESS
  }

  async function updateStatus(taskId, newStatus) {
    try {
      const response = await fetch(`/api/tasks/${taskId}/update-status/`, {
        method: "PATCH",
        headers: {
          Authorization: `Bearer ${localStorage.getItem("access_token")}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ status: newStatus }),
      });

      if (response.ok) {
        loadTasks(); // Reload
      } else {
        alert("Failed to update status");
      }
    } catch (e) {
      alert("Error updating status");
    }
  }

  function openAssignModal(taskId) {
    taskToAssign = taskId;
    const select = document.getElementById("assign-select");
    select.innerHTML = usersList
      .map((u) => `<option value="${u.id}">${u.email} (${u.role})</option>`)
      .join("");
    document.getElementById("assign-modal").style.display = "block";
  }

  function closeAssignModal() {
    document.getElementById("assign-modal").style.display = "none";
    taskToAssign = null;
  }

  async function confirmAssign() {
    const userId = document.getElementById("assign-select").value;
    if (!userId || !taskToAssign) return;

    try {
      const response = await fetch(
        `/api/tasks/${currentOrgId}/${taskToAssign}/assign/`,
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("access_token")}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ assigned_to: userId }),
        },
      );

      if (response.ok) {
        closeAssignModal();
        loadTasks();
      } else {
        const data = await response.json();
        alert(data.detail || "Assignment failed");
      }
    } catch (e) {
      alert("Error assigning task");
    }
  }

  // Activity Modal Logic
  async function openActivityModal(taskId) {
    document.getElementById("activity-modal").style.display = "block";
    const list = document.getElementById("activity-list");
    list.innerHTML = '<li class="text-muted">Loading...</li>';

    try {
      const response = await fetch(`/api/tasks/${taskId}/activity/`, {
        headers: {
          Authorization: `Bearer ${localStorage.getItem("access_token")}`,
        },
      });
      const activities = await response.json();

      if (activities.length === 0) {
        list.innerHTML = '<li class="text-muted">No activity recorded.</li>';
        return;
      }

      list.innerHTML = activities
        .map(
          (a) => `
              <li style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--color-border);">
                  <div class="flex justify-between items-center mb-1">
                    <span class="font-medium text-small text-muted">${new Date(a.created_at).toLocaleString()}</span>
                    <span class="badge badge-neutral" style="font-size: 0.7rem;">${a.activity_type}</span>
                  </div>
                  <div style="margin-bottom: 0.25rem;">${a.message}</div>
                  <div class="text-small text-muted">By: ${a.actor_email || "Unknown"}</div>
              </li>
          `,
        )
        .join("");
    } catch (e) {
      list.innerHTML = '<li class="alert-error">Failed to load activity.</li>';
    }
  }

  function closeActivityModal() {
    document.getElementById("activity-modal").style.display = "none";
  }

  // Create Task Logic
  function openCreateTaskModal() {
    document.getElementById("create-modal").style.display = "block";
    document.getElementById("new-task-title").focus();
  }

  function closeCreateTaskModal() {
    document.getElementById("create-modal").style.display = "none";
    document.getElementById("new-task-title").value = "";
    document.getElementById("new-task-desc").value = "";
  }

  async function createTask() {
    const title = document.getElementById("new-task-title").value;
    const description = document.getElementById("new-task-desc").value;

    if (!title) return alert("Title is required");

    try {
      const response = await fetch(
        `/api/tasks/${currentOrgId}/${currentProjectId}/create/`,
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("access_token")}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ title, description }),
        },
      );

      if (response.ok) {
        closeCreateTaskModal();
        loadTasks();
      } else {
        const data = await response.json();
        alert(data.detail || "Failed to create task");
      }
    } catch (e) {
      alert("Error creating task");
    }
  }
</script>
{% endblock %}
