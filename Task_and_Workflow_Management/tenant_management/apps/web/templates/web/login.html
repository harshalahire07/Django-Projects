{% extends 'web/base.html' %}
{% block title %}Login - Taskflow{% endblock %}

{% block layout %}
<!-- Auth layout: no sidebar -->
<div class="auth-layout">
  <div class="auth-form-card">
    <div class="card card-accent">
      <div class="text-center mb-4">
        <div class="avatar-circle avatar-xl" style="margin: 0 auto 1rem; background: linear-gradient(135deg, var(--color-primary) 0%, #7c3aed 100%);">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </div>
        <h2 style="margin-bottom: 0.375rem;">Welcome back</h2>
        <p class="text-muted" style="margin-bottom: 0;">Sign in to your account to continue</p>
      </div>

      <div id="error-msg" class="alert alert-error" style="display: none; margin-bottom: 1rem;"></div>

      <form id="login-form">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" required placeholder="name@company.com" />
        </div>
        <div class="form-group">
          <div class="flex justify-between items-center mb-1">
            <label for="password" style="margin-bottom: 0;">Password</label>
          </div>
          <input type="password" id="password" required placeholder="Enter your password" />
        </div>
        <button type="submit" class="btn btn-primary btn-block" id="login-btn">
          <span class="btn-text">Sign In â†’</span>
          <span class="spinner"></span>
        </button>
      </form>

      <div class="text-center mt-6 border-t" style="padding-top: 1.25rem;">
        <p class="text-small text-muted" style="margin-bottom: 0;">
          Don't have an account?
          <a href="/register/" class="text-primary font-semibold">Create an account</a>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container" class="toast-container"></div>
{% load static %}
<script src="{% static 'web/js/app.js' %}"></script>
<script>
  document.getElementById("login-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const errorDiv = document.getElementById("error-msg");
    const btn = document.getElementById("login-btn");

    btn.classList.add("loading");
    btn.disabled = true;
    errorDiv.style.display = "none";

    try {
      const response = await fetch("/api/accounts/login/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password }),
      });

      const data = await response.json();

      if (response.ok) {
        localStorage.setItem("access_token", data.access);
        localStorage.setItem("refresh_token", data.refresh);
        window.location.href = "/dashboard/";
      } else {
        errorDiv.textContent = data.detail || "Invalid credentials";
        errorDiv.style.display = "flex";
        btn.classList.remove("loading");
        btn.disabled = false;
      }
    } catch (error) {
      errorDiv.textContent = "An error occurred. Please try again.";
      errorDiv.style.display = "flex";
      btn.classList.remove("loading");
      btn.disabled = false;
    }
  });

  if (localStorage.getItem("access_token")) {
    window.location.href = "/dashboard/";
  }
</script>
{% endblock %}
