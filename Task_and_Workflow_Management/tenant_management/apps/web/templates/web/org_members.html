{% extends 'web/base.html' %}
{% block title %}Members - Taskflow{% endblock %}

{% block breadcrumb %}
<a href="/dashboard/">Dashboard</a>
<span class="separator">/</span>
<a href="#" id="back-link">Projects</a>
<span class="separator">/</span>
<span class="current">Members</span>
{% endblock %}

{% block sidebar_extra %}
<div class="sidebar-section-label">Organization</div>
<a href="#" id="sidebar-projects" class="sidebar-link">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
  </svg>
  Projects
</a>
<a href="#" class="sidebar-link active">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
    <circle cx="9" cy="7" r="4"></circle>
    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
  </svg>
  Members
</a>
{% endblock %}

{% block topbar_actions %}
<div id="admin-actions" style="display: none;">
  <button class="btn btn-primary btn-sm" onclick="openModal('invite-modal')">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    Invite Member
  </button>
</div>
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="page-title-group">
    <h1>Team Members</h1>
    <p>Manage access and roles</p>
  </div>
</div>

<div id="members-grid" class="grid grid-cols-auto">
  <div class="card skeleton skeleton-card" style="height: 80px;"></div>
  <div class="card skeleton skeleton-card" style="height: 80px;"></div>
</div>

<!-- Invite Modal -->
<div id="invite-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Invite New Member</div>
      <button class="modal-close" onclick="closeModal('invite-modal')">&times;</button>
    </div>
    <div class="form-group">
      <label for="invite-email">User Email</label>
      <input type="email" id="invite-email" placeholder="colleague@company.com" />
    </div>
    <div class="modal-actions">
      <button onclick="closeModal('invite-modal')" class="btn btn-secondary">Cancel</button>
      <button onclick="inviteMember()" class="btn btn-primary">Send Invite</button>
    </div>
  </div>
</div>

<script>
  let currentOrgId;

  document.addEventListener("DOMContentLoaded", async () => {
    const pathParts = window.location.pathname.split("/");
    currentOrgId = pathParts[2];

    document.getElementById("back-link").href = `/organizations/${currentOrgId}/projects/`;
    document.getElementById("sidebar-projects").href = `/organizations/${currentOrgId}/projects/`;

    const grid = document.getElementById("members-grid");

    const token = localStorage.getItem("access_token");
    if (!token) return logout();
    const payload = JSON.parse(atob(token.split(".")[1]));
    const currentUserId = payload.user_id;

    try {
      const response = await fetch(`/api/organizations/${currentOrgId}/members/`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.status === 401) return logout();
      if (response.status === 403) {
        grid.innerHTML = '<div class="alert alert-error">Access Denied</div>';
        return;
      }

      const members = await response.json();
      const me = members.find((m) => m.id == currentUserId);

      if (me && me.role === "ADMIN") {
        document.getElementById("admin-actions").style.display = "block";
      }

      grid.innerHTML = members.map((m) => `
        <div class="card flex items-center justify-between" style="padding: 1.25rem 1.5rem;">
          <div class="flex items-center gap-3">
            <div class="avatar-circle">${m.email[0].toUpperCase()}</div>
            <div>
              <div class="font-medium text-small">${m.email}</div>
              <div class="text-xs text-faint">Joined ${new Date(m.date_joined).toLocaleDateString()}</div>
            </div>
          </div>
          <span class="badge ${m.role === "ADMIN" ? "badge-primary" : "badge-neutral"}">
            <span class="badge-dot"></span>${m.role}
          </span>
        </div>
      `).join("");
    } catch (error) {
      grid.innerHTML = '<div class="alert alert-error">Failed to load members</div>';
    }
  });

  async function inviteMember() {
    const email = document.getElementById("invite-email").value;
    if (!email) return showToast("Email is required", "warning");

    try {
      const response = await fetch(`/api/organizations/${currentOrgId}/add_member/`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${localStorage.getItem("access_token")}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ email, role: "MEMBER" }),
      });

      if (response.ok) {
        showToast("Member added successfully!", "success");
        closeModal("invite-modal");
        location.reload();
      } else {
        const data = await response.json();
        showToast(data.detail || "Failed to add member", "error");
      }
    } catch (e) {
      showToast("Error adding member", "error");
    }
  }
</script>
{% endblock %}
