{% extends 'web/base.html' %}
{% block title %}Members - Taskflow{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title-group">
    <div class="flex items-center gap-2 mb-2">
      <a
        href="/dashboard/"
        class="text-muted hover:text-primary transition-colors"
        >Dashboard</a
      >
      <span class="text-muted">/</span>
      <a
        id="back-link"
        href="#"
        class="text-muted hover:text-primary transition-colors"
        >Projects</a
      >
      <span class="text-muted">/</span>
      <span class="font-medium">Members</span>
    </div>
    <h1>Team Members</h1>
    <p class="text-muted">Manage access and roles</p>
  </div>
  <div id="admin-actions" style="display: none">
    <button class="btn btn-primary" onclick="openInviteModal()">
      <span>+</span> Invite Member
    </button>
  </div>
</div>

<div id="members-grid" class="grid grid-cols-auto">
  <div class="card">
    <p class="text-muted">Loading members...</p>
  </div>
</div>

<!-- Invite Modal -->
<div id="invite-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Invite New Member</div>
    </div>
    <div class="form-group">
      <label for="invite-email">User Email</label>
      <input
        type="email"
        id="invite-email"
        placeholder="colleague@company.com"
      />
    </div>
    <div class="modal-actions">
      <button onclick="closeInviteModal()" class="btn btn-secondary">
        Cancel
      </button>
      <button onclick="inviteMember()" class="btn btn-primary">
        Send Invite
      </button>
    </div>
  </div>
</div>

<script>
  let currentOrgId;

  document.addEventListener("DOMContentLoaded", async () => {
    const pathParts = window.location.pathname.split("/");
    currentOrgId = pathParts[2]; // /organizations/{id}/members/

    document.getElementById("back-link").href =
      `/organizations/${currentOrgId}/projects/`;

    const grid = document.getElementById("members-grid");

    // Check Role
    const token = localStorage.getItem("access_token");
    if (!token) return logout();
    const payload = JSON.parse(atob(token.split(".")[1]));
    const currentUserId = payload.user_id;

    try {
      const response = await fetch(
        `/api/organizations/${currentOrgId}/members/`,
        {
          headers: { Authorization: `Bearer ${token}` },
        },
      );

      if (response.status === 401) return logout();
      if (response.status === 403) {
        grid.innerHTML =
          '<div class="alert alert-error">Access Denied</div>';
        return;
      }

      const members = await response.json();
      const me = members.find((m) => m.id == currentUserId);

      if (me && me.role === "ADMIN") {
        document.getElementById("admin-actions").style.display = "block";
      }

      grid.innerHTML = members
        .map(
          (m) => `
            <div class="card flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="avatar-circle">${m.email[0].toUpperCase()}</div>
                    <div>
                        <div class="font-medium">${m.email}</div>
                        <div class="text-small text-muted">Joined ${new Date(m.date_joined).toLocaleDateString()}</div>
                    </div>
                </div>
                <div>
                    <span class="badge ${m.role === "ADMIN" ? "badge-primary" : "badge-neutral"}">${m.role}</span>
                </div>
            </div>
        `,
        )
        .join("");
    } catch (error) {
      grid.innerHTML =
        '<div class="alert alert-error">Failed to load members</div>';
    }
  });

  function openInviteModal() {
    document.getElementById("invite-modal").style.display = "block";
    document.getElementById("invite-email").focus();
  }

  function closeInviteModal() {
    document.getElementById("invite-modal").style.display = "none";
    document.getElementById("invite-email").value = "";
  }

  async function inviteMember() {
    const email = document.getElementById("invite-email").value;
    if (!email) return alert("Email is required");

    try {
      const response = await fetch(
        `/api/organizations/${currentOrgId}/add_member/`,
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${localStorage.getItem("access_token")}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ email, role: "MEMBER" }),
        },
      );

      if (response.ok) {
        alert("Member added successfully!");
        closeInviteModal();
        location.reload();
      } else {
        const data = await response.json();
        alert(data.detail || "Failed to add member");
      }
    } catch (e) {
      alert("Error adding member");
    }
  }
</script>
{% endblock %}
