{% extends 'web/base.html' %}
{% block title %}Members - Taskflow{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title-group">
    <div
      style="
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
      "
    >
      <a id="back-link" href="#" class="btn btn-sm btn-secondary"
        >&larr; Projects</a
      >
      <h1 style="margin: 0">Organization Members</h1>
    </div>
    <p class="text-muted" style="margin-left: 0.5rem">
      People with access to this organization
    </p>
  </div>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th style="width: 50%">Email</th>
        <th style="width: 20%">Role</th>
        <th style="width: 30%">Joined</th>
      </tr>
    </thead>
    <tbody id="members-body">
      <tr>
        <td colspan="3" class="text-center text-muted">Loading...</td>
      </tr>
    </tbody>
  </table>
</div>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const pathParts = window.location.pathname.split("/");
    const orgId = pathParts[2]; // /organizations/{id}/members/

    document.getElementById("back-link").href =
      `/organizations/${orgId}/projects/`;

    const tbody = document.getElementById("members-body");

    try {
      const response = await fetch(`/api/organizations/${orgId}/members/`, {
        headers: {
          Authorization: `Bearer ${localStorage.getItem("access_token")}`,
        },
      });

      if (response.status === 401) {
        logout();
        return;
      }

      const members = await response.json();

      if (members.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="3" class="text-center text-muted">No members found.</td></tr>';
        return;
      }

      tbody.innerHTML = members
        .map(
          (m) => `
            <tr>
                <td>
                    <div class="flex items-center gap-2">
                         <div class="avatar-circle">${m.email[0].toUpperCase()}</div>
                        <span class="font-medium">${m.email}</span>
                    </div>
                </td>
                <td><span class="badge ${m.role === "ADMIN" ? "badge-primary" : "badge-neutral"}">${m.role}</span></td>
                <td>${new Date(m.joined_at).toLocaleDateString()}</td>
            </tr>
        `,
        )
        .join("");
    } catch (e) {
      tbody.innerHTML =
        '<tr><td colspan="3" class="alert-error">Error loading members.</td></tr>';
    }
  });
</script>
{% endblock %}
