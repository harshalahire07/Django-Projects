{% extends 'web/base.html' %}
{% block title %}Projects - Taskflow{% endblock %}

{% block breadcrumb %}
<a href="/dashboard/">Dashboard</a>
<span class="separator">/</span>
<span class="current">Projects</span>
{% endblock %}

{% block sidebar_extra %}
<div class="sidebar-section-label">Organization</div>
<a href="#" id="sidebar-projects" class="sidebar-link active">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
  </svg>
  Projects
</a>
<a href="#" id="sidebar-members" class="sidebar-link">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
    <circle cx="9" cy="7" r="4"></circle>
    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
  </svg>
  Members
</a>
<a href="#" id="sidebar-audit" class="sidebar-link" style="display: none;">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
    <polyline points="14 2 14 8 20 8"></polyline>
    <line x1="16" y1="13" x2="8" y2="13"></line>
    <line x1="16" y1="17" x2="8" y2="17"></line>
  </svg>
  Audit Logs
</a>
{% endblock %}

{% block topbar_actions %}
<button class="btn btn-primary btn-sm" id="create-project-btn" style="display: none;" onclick="openModal('create-modal')">
  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  New Project
</button>
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="page-title-group">
    <h1>Projects</h1>
    <p>Manage your team's work and track progress.</p>
  </div>
</div>

<div id="projects-grid" class="grid grid-cols-auto">
  <div class="card skeleton skeleton-card"></div>
  <div class="card skeleton skeleton-card"></div>
</div>

<!-- Create Project Modal -->
<div id="create-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Create New Project</div>
      <button class="modal-close" onclick="closeModal('create-modal')">&times;</button>
    </div>

    <div class="form-group">
      <label for="new-proj-name">Project Name</label>
      <input type="text" id="new-proj-name" placeholder="e.g. Q4 Marketing Campaign" />
    </div>

    <div class="form-group">
      <label for="new-proj-desc">Description (Optional)</label>
      <textarea id="new-proj-desc" placeholder="What is this project about?" rows="3" style="resize: vertical;"></textarea>
    </div>

    <div class="modal-actions">
      <button onclick="closeModal('create-modal')" class="btn btn-secondary">Cancel</button>
      <button onclick="createProject()" class="btn btn-primary">Create Project</button>
    </div>
  </div>
</div>

<script>
  let currentOrgId;

  document.addEventListener("DOMContentLoaded", async () => {
    const pathParts = window.location.pathname.split("/");
    currentOrgId = pathParts[2];

    document.getElementById("sidebar-members").href = `/organizations/${currentOrgId}/members/`;
    document.getElementById("sidebar-audit").href = `/organizations/${currentOrgId}/audit/`;
    document.getElementById("sidebar-projects").href = `/organizations/${currentOrgId}/projects/`;

    checkRole();

    const grid = document.getElementById("projects-grid");

    try {
      const response = await fetch(`/api/projects/${currentOrgId}/list/`, {
        headers: { Authorization: `Bearer ${localStorage.getItem("access_token")}` },
      });

      if (response.status === 401) { logout(); return; }
      if (response.status === 403) {
        grid.innerHTML = '<div class="alert alert-error">Access denied. You do not have permission to view this organization.</div>';
        return;
      }

      const projects = await response.json();

      if (projects.length === 0) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <div class="empty-icon">ðŸ“‚</div>
            <h3>No Projects Found</h3>
            <p>Projects help you organize tasks. Create one to get started.</p>
            <div id="empty-state-action" style="display:none;">
              <button class="btn btn-primary mt-4" onclick="openModal('create-modal')">Create Project</button>
            </div>
          </div>
        `;
        return;
      }

      grid.innerHTML = projects.map((p) => `
        <a href="/organizations/${currentOrgId}/projects/${p.id}/tasks/" class="card card-hover flex flex-col justify-between" style="min-height: 180px;">
          <div class="card-body">
            <div class="card-title" style="font-size: 1.075rem;">${p.name}</div>
            <p class="text-muted text-small line-clamp-2" style="margin-bottom: 0;">
              ${p.description || "No description provided."}
            </p>
          </div>
          <div class="card-footer flex justify-between items-center">
            <span class="text-xs font-medium text-primary">View Tasks â†’</span>
            <span class="text-xs text-faint">Open â†’</span>
          </div>
        </a>
      `).join("");
    } catch (error) {
      console.error(error);
      grid.innerHTML = '<div class="alert alert-error">Error loading projects. Please try refreshing.</div>';
    }
  });

  async function checkRole() {
    try {
      const token = localStorage.getItem("access_token");
      const payload = JSON.parse(atob(token.split(".")[1]));
      const userId = payload.user_id;

      const response = await fetch(`/api/organizations/${currentOrgId}/members/`, {
        headers: { Authorization: `Bearer ${token}` },
      });
      const members = await response.json();
      const me = members.find((m) => m.id == userId);

      if (me && me.role === "ADMIN") {
        document.getElementById("create-project-btn").style.display = "inline-flex";
        document.getElementById("sidebar-audit").style.display = "flex";
        const emptyAction = document.getElementById("empty-state-action");
        if (emptyAction) emptyAction.style.display = "block";
      }
    } catch (e) {
      console.error("Role check failed", e);
    }
  }

  async function createProject() {
    const name = document.getElementById("new-proj-name").value;
    const description = document.getElementById("new-proj-desc").value;

    if (!name) return showToast("Project name is required", "warning");

    try {
      const response = await fetch(`/api/projects/${currentOrgId}/create/`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${localStorage.getItem("access_token")}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ name, description }),
      });

      if (response.ok) {
        closeModal("create-modal");
        showToast("Project created successfully!", "success");
        location.reload();
      } else {
        const data = await response.json();
        showToast(data.detail || "Failed to create project", "error");
      }
    } catch (e) {
      showToast("Error creating project", "error");
    }
  }
</script>
{% endblock %}
