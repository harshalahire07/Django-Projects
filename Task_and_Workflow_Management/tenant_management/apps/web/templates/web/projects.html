{% extends 'web/base.html' %} {% block title %}Projects - Taskflow{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title-group">
    <div
      style="
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.5rem;
      "
    >
      <a href="/dashboard/" class="btn btn-sm btn-secondary"
        >&larr; Dashboard</a
      >
      <h1 style="margin: 0">Projects</h1>
    </div>
    <p class="text-muted" style="margin-left: 0.5rem">
      Manage projects within this organization
    </p>
  </div>
  <div class="flex gap-2">
    <a id="members-link" href="#" class="btn btn-secondary">Members</a>
    <a id="audit-link" href="#" class="btn btn-secondary" style="display: none"
      >Audit Logs</a
    >
    <button
      class="btn btn-primary"
      id="create-project-btn"
      style="display: none"
      onclick="openCreateProjectModal()"
    >
      <span>+</span> New Project
    </button>
  </div>
</div>

<div id="projects-grid" class="grid grid-cols-auto">
  <p class="text-muted">Loading projects...</p>
</div>

<!-- Create Project Modal -->
<div id="create-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title">Create Project</div>
    </div>

    <div class="form-group">
      <label for="new-proj-name">Project Name</label>
      <input type="text" id="new-proj-name" placeholder="Enter project name" />
    </div>

    <div class="form-group">
      <label for="new-proj-desc">Description</label>
      <textarea
        id="new-proj-desc"
        placeholder="Brief description of the project"
        rows="3"
      ></textarea>
    </div>

    <div class="modal-actions">
      <button onclick="closeCreateProjectModal()" class="btn btn-secondary">
        Cancel
      </button>
      <button onclick="createProject()" class="btn btn-primary">
        Create Project
      </button>
    </div>
  </div>
</div>

<script>
  let currentOrgId;

  document.addEventListener("DOMContentLoaded", async () => {
    const pathParts = window.location.pathname.split("/");
    currentOrgId = pathParts[2]; // /organizations/{id}/projects/

    document.getElementById("members-link").href =
      `/organizations/${currentOrgId}/members/`;
    document.getElementById("audit-link").href =
      `/organizations/${currentOrgId}/audit/`;

    const grid = document.getElementById("projects-grid");

    // Check role first
    checkRole();

    try {
      const response = await fetch(`/api/projects/${currentOrgId}/list/`, {
        headers: {
          Authorization: `Bearer ${localStorage.getItem("access_token")}`,
        },
      });

      if (response.status === 401) {
        logout();
        return;
      }
      if (response.status === 403) {
        grid.innerHTML = '<div class="alert alert-error">Access denied.</div>';
        return;
      }

      const projects = await response.json();

      if (projects.length === 0) {
        grid.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
                <div class="empty-icon">üìÅ</div>
                <h3>No Projects Yet</h3>
                <p>Start by creating your first project.</p>
                <button class="btn btn-primary mt-4" onclick="openCreateProjectModal()">Create Project</button>
            </div>
        `;
        return;
      }

      grid.innerHTML = projects
        .map(
          (p) => `
                <a href="/organizations/${currentOrgId}/projects/${p.id}/tasks/" class="card card-hover">
                    <div class="card-title">${p.name}</div>
                    <p class="text-muted text-small" style="margin-bottom: 1rem; min-height: 40px;">
                        ${p.description || "No description provided."}
                    </p>
                    <div class="badge badge-neutral">View Tasks &rarr;</div>
                </a>
            `,
        )
        .join("");
    } catch (error) {
      console.error(error);
      grid.innerHTML =
        '<div class="alert alert-error">Error loading projects.</div>';
    }
  });

  async function checkRole() {
    try {
      const token = localStorage.getItem("access_token");
      const payload = JSON.parse(atob(token.split(".")[1]));
      const userId = payload.user_id;

      const response = await fetch(
        `/api/organizations/${currentOrgId}/members/`,
        {
          headers: { Authorization: `Bearer ${token}` },
        },
      );
      const members = await response.json();
      const me = members.find((m) => m.id == userId);

      if (me && me.role === "ADMIN") {
        document.getElementById("create-project-btn").style.display = "block";
        document.getElementById("audit-link").style.display = "inline-flex";
      }
    } catch (e) {
      console.error("Role check failed", e);
    }
  }

  function openCreateProjectModal() {
    document.getElementById("create-modal").style.display = "block";
    document.getElementById("new-proj-name").focus();
  }

  function closeCreateProjectModal() {
    document.getElementById("create-modal").style.display = "none";
    document.getElementById("new-proj-name").value = "";
    document.getElementById("new-proj-desc").value = "";
  }

  async function createProject() {
    const name = document.getElementById("new-proj-name").value;
    const description = document.getElementById("new-proj-desc").value;

    if (!name) return alert("Name is required");

    try {
      const response = await fetch(`/api/projects/${currentOrgId}/create/`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${localStorage.getItem("access_token")}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ name, description }),
      });

      if (response.ok) {
        closeCreateProjectModal();
        location.reload();
      } else {
        const data = await response.json();
        alert(data.detail || "Failed to create project");
      }
    } catch (e) {
      alert("Error creating project");
    }
  }
</script>
{% endblock %}
