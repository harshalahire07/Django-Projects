{% extends 'web/base.html' %}
{% block title %}Audit Logs - Taskflow{% endblock %}

{% block breadcrumb %}
<a href="/dashboard/">Dashboard</a>
<span class="separator">/</span>
<a href="#" id="back-link">Projects</a>
<span class="separator">/</span>
<span class="current">Audit Logs</span>
{% endblock %}

{% block sidebar_extra %}
<div class="sidebar-section-label">Organization</div>
<a href="#" id="sidebar-projects" class="sidebar-link">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
  </svg>
  Projects
</a>
<a href="#" id="sidebar-members" class="sidebar-link">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
    <circle cx="9" cy="7" r="4"></circle>
    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
  </svg>
  Members
</a>
<a href="#" class="sidebar-link active">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
    <polyline points="14 2 14 8 20 8"></polyline>
    <line x1="16" y1="13" x2="8" y2="13"></line>
    <line x1="16" y1="17" x2="8" y2="17"></line>
  </svg>
  Audit Logs
</a>
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="page-title-group">
    <h1>Audit Logs</h1>
    <p>Activity history for this organization</p>
  </div>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th style="width: 20%; padding-left: 1.5rem;">Time</th>
        <th style="width: 25%;">Actor</th>
        <th style="width: 15%;">Action</th>
        <th style="width: 40%;">Description</th>
      </tr>
    </thead>
    <tbody id="logs-body">
      <tr>
        <td colspan="4" style="padding: 0;">
          <div class="skeleton-table-row"><div class="skeleton skeleton-line w-25" style="margin-bottom:0;"></div><div class="skeleton skeleton-avatar"></div><div class="skeleton skeleton-line w-50" style="flex:1;margin-bottom:0;"></div></div>
          <div class="skeleton-table-row"><div class="skeleton skeleton-line w-25" style="margin-bottom:0;"></div><div class="skeleton skeleton-avatar"></div><div class="skeleton skeleton-line w-75" style="flex:1;margin-bottom:0;"></div></div>
          <div class="skeleton-table-row"><div class="skeleton skeleton-line w-25" style="margin-bottom:0;"></div><div class="skeleton skeleton-avatar"></div><div class="skeleton skeleton-line w-50" style="flex:1;margin-bottom:0;"></div></div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const pathParts = window.location.pathname.split("/");
    const orgId = pathParts[2];

    document.getElementById("back-link").href = `/organizations/${orgId}/projects/`;
    document.getElementById("sidebar-projects").href = `/organizations/${orgId}/projects/`;
    document.getElementById("sidebar-members").href = `/organizations/${orgId}/members/`;

    const tbody = document.getElementById("logs-body");

    try {
      const response = await fetch(`/api/audit/${orgId}/logs/`, {
        headers: { Authorization: `Bearer ${localStorage.getItem("access_token")}` },
      });

      if (response.status === 401) { logout(); return; }
      if (response.status === 403) {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center" style="padding:2rem;"><div class="alert alert-error" style="display:inline-flex;">Access Denied. Admin only.</div></td></tr>';
        return;
      }

      const logs = await response.json();

      if (logs.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center" style="padding: 3.5rem;">
          <div class="empty-icon" style="font-size:2rem;">ðŸ“œ</div>
          <div class="font-medium mt-2" style="color:var(--color-text-main);">No Logs Found</div>
          <div class="text-small text-muted mt-1">Activity will appear here as actions are performed.</div>
        </td></tr>`;
        return;
      }

      tbody.innerHTML = logs.map((l) => {
        let actionClass = "badge-neutral";
        const actionLower = l.action.toLowerCase();
        if (actionLower.includes("create")) actionClass = "badge-success";
        else if (actionLower.includes("update") || actionLower.includes("assign")) actionClass = "badge-warning";
        else if (actionLower.includes("delete") || actionLower.includes("remove")) actionClass = "badge-danger";

        return `
          <tr>
            <td class="text-muted text-xs" style="padding-left: 1.5rem;">${new Date(l.created_at).toLocaleString()}</td>
            <td>
              <div class="flex items-center gap-2">
                <div class="avatar-circle avatar-sm">${l.actor_email[0].toUpperCase()}</div>
                <span class="font-medium text-small">${l.actor_email}</span>
              </div>
            </td>
            <td><span class="badge ${actionClass}"><span class="badge-dot"></span>${l.action}</span></td>
            <td class="text-small text-muted">${l.description}</td>
          </tr>`;
      }).join("");
    } catch (e) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center"><div class="alert alert-error" style="display:inline-flex;">Error loading logs.</div></td></tr>';
    }
  });
</script>
{% endblock %}
