{% extends 'web/base.html' %}
{% block title %}Audit Logs - Taskflow{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title-group">
    <div class="flex items-center gap-2 mb-2">
      <a
        href="/dashboard/"
        class="text-muted hover:text-primary transition-colors"
        >Dashboard</a
      >
      <span class="text-muted">/</span>
      <a
        id="back-link"
        href="#"
        class="text-muted hover:text-primary transition-colors"
        >Projects</a
      >
      <span class="text-muted">/</span>
      <span class="font-medium">Audit Logs</span>
    </div>
    <h1>Audit Logs</h1>
    <p class="text-muted">Activity history for this organization</p>
  </div>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th style="width: 20%; padding-left: 2rem">Time</th>
        <th style="width: 25%">Actor</th>
        <th style="width: 15%">Action</th>
        <th style="width: 40%">Description</th>
      </tr>
    </thead>
    <tbody id="logs-body">
      <tr>
        <td colspan="4" class="text-center text-muted" style="padding: 3rem">
          <span style="display: inline-block; animation: pulse 1.5s infinite"
            >Loading logs...</span
          >
        </td>
      </tr>
    </tbody>
  </table>
</div>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const pathParts = window.location.pathname.split("/");
    const orgId = pathParts[2]; // /organizations/{id}/audit/

    document.getElementById("back-link").href =
      `/organizations/${orgId}/projects/`;

    const tbody = document.getElementById("logs-body");

    try {
      const response = await fetch(`/api/audit/${orgId}/logs/`, {
        headers: {
          Authorization: `Bearer ${localStorage.getItem("access_token")}`,
        },
      });

      if (response.status === 401) {
        logout();
        return;
      }
      if (response.status === 403) {
        tbody.innerHTML =
          '<tr><td colspan="4" class="alert-error text-center">Access Denied. Admin only.</td></tr>';
        return;
      }

      const logs = await response.json();

      if (logs.length === 0) {
        tbody.innerHTML =
          '<tr><td colspan="4" class="text-center text-muted" style="padding: 3rem;">No logs found.</td></tr>';
        return;
      }

      tbody.innerHTML = logs
        .map(
          (l) => `
            <tr>
                <td class="text-muted text-small" style="padding-left: 2rem;">${new Date(l.created_at).toLocaleString()}</td>
                <td>
                    <div class="flex items-center gap-2">
                         <div class="avatar-circle" style="width: 24px; height: 24px; font-size: 0.7rem;">${l.actor_email[0].toUpperCase()}</div>
                         <span class="font-medium text-small">${l.actor_email}</span>
                    </div>
                </td>
                <td><span class="badge badge-neutral">${l.action}</span></td>
                <td class="text-small text-muted">${l.description}</td>
            </tr>
        `,
        )
        .join("");
    } catch (e) {
      tbody.innerHTML =
        '<tr><td colspan="4" class="alert-error text-center">Error loading logs.</td></tr>';
    }
  });
</script>
{% endblock %}
